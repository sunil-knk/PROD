name: Production Release Tag

on:
  pull_request:
    types: [closed]
    branches:
      - test/PROD

jobs:
  create-prod-release:
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.title, 'Sprint Release:')
    runs-on: ubuntu-latest

    env:
      TARGET_BRANCH: test/PROD

    steps:
      - name: Checkout repository
        run: |
          git init
          git remote add origin https://github.com/${{ github.repository }}.git
          git fetch origin --tags --prune --unshallow || git fetch origin --tags --prune
          git fetch origin +refs/heads/*:refs/remotes/origin/*
          git checkout origin/${TARGET_BRANCH}

      - name: Configure Git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Find latest sprint tag
        id: get_tag
        run: |
          LAST_TAG=$(git tag --list 'sprint_*' | sort -V | tail -n 1)
          if [ -z "$LAST_TAG" ]; then
            echo "LAST_TAG=none" >> $GITHUB_ENV
            echo "NEW_TAG=sprint_1" >> $GITHUB_ENV
          else
            NUM=$(echo $LAST_TAG | grep -o '[0-9]*$')
            NEXT=$((NUM + 1))
            echo "LAST_TAG=$LAST_TAG" >> $GITHUB_ENV
            echo "NEW_TAG=sprint_${NEXT}" >> $GITHUB_ENV
          fi

      - name: Get only direct commits from target branch
        id: commits
        run: |
          echo "Fetching direct commits from ${TARGET_BRANCH}..."

          git fetch origin --tags --prune --unshallow || git fetch origin --tags --prune

          # List commits only from the target branch, excluding merges
          COMMITS=$(git log origin/${TARGET_BRANCH} --pretty=format:"%h %s" --no-merges)

          # Exclude merges, cherry-picks, rebased commits, or cross-branch merges
          FILTERED_COMMITS=$(echo "$COMMITS" | grep -Ev "Merge branch|Merge pull request|from feature/|from release/|from hotfix/|cherry picked from commit" || true)

          # Remove duplicate SHAs in case of rebase
          UNIQUE_COMMITS=$(echo "$FILTERED_COMMITS" | awk '!seen[$1]++')

          echo "Filtered commits (direct commits only):"
          echo "$UNIQUE_COMMITS"

          {
            echo "COMMITS<<EOF"
            echo "$UNIQUE_COMMITS"
            echo "EOF"
          } >> $GITHUB_ENV

      - name: Create release via GitHub API
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Creating release with tag: $NEW_TAG"
          API_URL="https://api.github.com/repos/${{ github.repository }}/releases"

          RELEASE_BODY=$(printf "%s\n\nCommits in this release:\n%s" \
            "Automated release notes for ${NEW_TAG}" \
            "${COMMITS}")

          curl -s -X POST "$API_URL" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d "{
              \"tag_name\": \"$NEW_TAG\",
              \"target_commitish\": \"${TARGET_BRANCH}\",
              \"name\": \"$NEW_TAG\",
              \"body\": \"$RELEASE_BODY\",
              \"generate_release_notes\": true
            }"

      - name: Confirm release creation
        run: echo "Release $NEW_TAG created successfully for branch ${TARGET_BRANCH}"
