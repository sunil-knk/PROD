name: Production Release Tag

on:
  pull_request:
    types: [closed]
    branches:
      - test/PROD

jobs:
  create-prod-release:
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.title, 'Sprint Release:')
    runs-on: ubuntu-latest

    env:
      TARGET_BRANCH: test/PROD

    steps:
      - name: Checkout repository
        run: |
          git init
          git remote add origin https://github.com/${{ github.repository }}.git
          git fetch origin --tags --prune
          git fetch origin +refs/heads/*:refs/remotes/origin/*
          git checkout origin/${TARGET_BRANCH}

      - name: Configure Git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Find latest sprint tag
        id: get_tag
        run: |
          LAST_TAG=$(git tag --list 'sprint_*' | sort -V | tail -n 1)
          if [ -z "$LAST_TAG" ]; then
            echo "LAST_TAG=none" >> $GITHUB_ENV
            echo "NEW_TAG=sprint_1" >> $GITHUB_ENV
          else
            NUM=$(echo "$LAST_TAG" | grep -o '[0-9]*$')
            NEXT=$((NUM + 1))
            echo "LAST_TAG=$LAST_TAG" >> $GITHUB_ENV
            echo "NEW_TAG=sprint_${NEXT}" >> $GITHUB_ENV
          fi

      - name: Get commits only from target branch since last tag
        id: commits
        run: |
          if [ "$LAST_TAG" = "none" ]; then
            echo "No previous tag found — taking initial commits from ${TARGET_BRANCH}"
            RANGE="origin/${TARGET_BRANCH}"
          else
            RANGE="${LAST_TAG}..origin/${TARGET_BRANCH}"
          fi

          echo "Getting commits from range: $RANGE"

          # Only commits from test/PROD, excluding merges from other branches
          COMMITS=$(git log $RANGE --pretty=format:"%h %s" --no-merges | grep -Ev "from (feature/|release/|hotfix/)" || true)

          if [ -z "$COMMITS" ]; then
            echo "No valid commits found in ${TARGET_BRANCH} since ${LAST_TAG}."
            COMMITS="No new commits found in ${TARGET_BRANCH} since last release."
          fi

          echo "COMMITS<<EOF" >> $GITHUB_ENV
          echo "$COMMITS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Create release via GitHub API
        env:
          GH_TOKEN: ${{ secrets.SUNIL2_TOKEN }}
        run: |
          echo "Creating release with tag: $NEW_TAG"
          API_URL="https://api.github.com/repos/${{ github.repository }}/releases"

          # Escape for JSON
          SAFE_BODY=$(echo "${COMMITS}" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

          # Build JSON payload safely
          PAYLOAD=$(jq -n \
            --arg tag_name "$NEW_TAG" \
            --arg target_commitish "$TARGET_BRANCH" \
            --arg name "Sprint Release: $NEW_TAG" \
            --arg body "## Release Notes for $TARGET_BRANCH\n\nCommits:\n$SAFE_BODY" \
            '{
              tag_name: $tag_name,
              target_commitish: $target_commitish,
              name: $name,
              body: $body,
              generate_release_notes: true
            }'
          )

          echo "Payload to be sent:"
          echo "$PAYLOAD" | jq '.'

          RESPONSE=$(curl -s -o response.json -w "%{http_code}" -X POST "$API_URL" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d "$PAYLOAD")

          HTTP_CODE=$(tail -n1 <<< "$RESPONSE")

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✅ Release created successfully."
          else
            echo "❌ Failed to create release (HTTP $HTTP_CODE)"
            echo "Response:"
            cat response.json
            exit 1
          fi

      - name: Confirm release creation
        run: echo "Release $NEW_TAG created successfully for branch ${TARGET_BRANCH}"
